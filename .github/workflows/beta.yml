name: Beta
on:
    pull_request:
        types:
          - opened
          - reopened
          - synchronize
        paths:
          - src
          - package.json
          - tsconfig.json
jobs:
    build:
        name: Build
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v5

          - name: Setup Node.js
            uses: actions/setup-node@v5
            with:
                node-version: 24
                registry-url: 'https://registry.npmjs.org'

          - name: Cache dependencies
            uses: actions/cache@v4
            with:
                path: ~/.npm
                key: ${{ runner.os }}-npm-${{ hashFiles('**/package.json') }}
                restore-keys: |
                    ${{ runner.os }}-npm-

          - name: Install dependencies
            shell: bash
            run: npm install

          - name: Test
            shell: bash
            run: npm run test

          - name: Build
            shell: bash
            run: npm run build

          - name: Upload build
            uses: actions/upload-artifact@v5
            with:
                name: "dist"
                path: ./dist

    tag:
        name: Tag
        runs-on: ubuntu-latest
        permissions:
            contents: write
        needs:
          - build
        steps:
          - name: Checkout code
            uses: actions/checkout@v5

          - name: Setup Node.js
            uses: actions/setup-node@v5
            with:
                node-version: 24

          - name: Versions
            shell: bash
            run: |
                MAJOR=$(node -p "require('./package.json').version.split('.')[0]")
                MINOR=$(node -p "require('./package.json').version.split('.')[1]")
                PATCH=$(node -p "require('./package.json').version.split('.')[2]")
                echo "MAJOR=$MAJOR" >> $GITHUB_ENV
                echo "MINOR=$MINOR" >> $GITHUB_ENV
                echo "PATCH=$PATCH" >> $GITHUB_ENV

          - name: Setup GPG
            uses: ./.github/actions/setup-git-gpg
            with:
                id: ${{ vars.GPG_ID }}
                private-key: ${{ secrets.GPG_PRIVATE_KEY }}
                passphrase: ${{ secrets.GPG_PASSPHRASE }}

          - name: Setup git
            uses: ./.github/actions/setup-git
            with:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          - name: Checkout code
            uses: actions/checkout@v5
            with:
                ref: "release"

          - name: Download build
            uses: actions/download-artifact@v5
            with:
                name: "dist"

          - name: Create tag
            shell: bash
            run: |
                TAG_VERSION="beta"
                MAJOR_VERSION="v${{ env.MAJOR }}-beta"
                FULL_VERSION="v${{ env.MAJOR }}.${{ env.MINOR }}.${{ env.PATCH }}-beta"
                git add .
                git commit --allow-empty -S -m "Pre-release $FULL_VERSION"
                git tag -d $TAG_VERSION || true
                git tag -d $MAJOR_VERSION || true
                git tag -d $FULL_VERSION || true
                git tag -a $TAG_VERSION -m "Pre-release $FULL_VERSION"
                git tag -a $MAJOR_VERSION -m "Pre-release $FULL_VERSION"
                git tag -a $FULL_VERSION -m "Pre-release $FULL_VERSION"
                git push origin release
                git push origin $TAG_VERSION --force
                git push origin $MAJOR_VERSION --force
                git push origin $FULL_VERSION --force
